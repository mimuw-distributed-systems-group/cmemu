name: Test of code and data in flash
description: "A series of loads from flash in flash"
dumped_symbols:
  times: 1 words
configurations:
- { data: "same", code_cached: True, next_set_cached: True, lbEn: True, wbEn: True, load_next: True }
- { data: "same", code_cached: True, next_set_cached: True, lbEn: True, wbEn: True, load_next: False }
- { data: "same", code_cached: True, next_set_cached: True, lbEn: True, wbEn: False, load_next: True }
- { data: "same", code_cached: True, next_set_cached: True, lbEn: True, wbEn: False, load_next: False }
- { data: "same", code_cached: True, next_set_cached: True, lbEn: False, wbEn: True, load_next: True }
- { data: "same", code_cached: True, next_set_cached: True, lbEn: False, wbEn: True, load_next: False }
- { data: "same", code_cached: True, next_set_cached: True, lbEn: False, wbEn: False, load_next: True }
- { data: "same", code_cached: True, next_set_cached: True, lbEn: False, wbEn: False, load_next: False }
- { data: "same", code_cached: True, next_set_cached: False, lbEn: True, wbEn: True, load_next: True }
- { data: "same", code_cached: True, next_set_cached: False, lbEn: True, wbEn: True, load_next: False }
- { data: "same", code_cached: True, next_set_cached: False, lbEn: True, wbEn: False, load_next: True }
- { data: "same", code_cached: True, next_set_cached: False, lbEn: True, wbEn: False, load_next: False }
- { data: "same", code_cached: True, next_set_cached: False, lbEn: False, wbEn: True, load_next: True }
- { data: "same", code_cached: True, next_set_cached: False, lbEn: False, wbEn: True, load_next: False }
- { data: "same", code_cached: True, next_set_cached: False, lbEn: False, wbEn: False, load_next: True }
- { data: "same", code_cached: True, next_set_cached: False, lbEn: False, wbEn: False, load_next: False }
- { data: "same", code_cached: False, next_set_cached: True, lbEn: True, wbEn: True, load_next: True }
- { data: "same", code_cached: False, next_set_cached: True, lbEn: True, wbEn: True, load_next: False }
- { data: "same", code_cached: False, next_set_cached: True, lbEn: True, wbEn: False, load_next: True }
- { data: "same", code_cached: False, next_set_cached: True, lbEn: True, wbEn: False, load_next: False }
- { data: "same", code_cached: False, next_set_cached: True, lbEn: False, wbEn: True, load_next: True }
- { data: "same", code_cached: False, next_set_cached: True, lbEn: False, wbEn: True, load_next: False }
- { data: "same", code_cached: False, next_set_cached: True, lbEn: False, wbEn: False, load_next: True }
- { data: "same", code_cached: False, next_set_cached: True, lbEn: False, wbEn: False, load_next: False }
- { data: "same", code_cached: False, next_set_cached: False, lbEn: True, wbEn: True, load_next: True }
- { data: "same", code_cached: False, next_set_cached: False, lbEn: True, wbEn: True, load_next: False }
- { data: "same", code_cached: False, next_set_cached: False, lbEn: True, wbEn: False, load_next: True }
- { data: "same", code_cached: False, next_set_cached: False, lbEn: True, wbEn: False, load_next: False }
- { data: "same", code_cached: False, next_set_cached: False, lbEn: False, wbEn: True, load_next: True }
- { data: "same", code_cached: False, next_set_cached: False, lbEn: False, wbEn: True, load_next: False }
- { data: "same", code_cached: False, next_set_cached: False, lbEn: False, wbEn: False, load_next: True }
- { data: "same", code_cached: False, next_set_cached: False, lbEn: False, wbEn: False, load_next: False }
- { data: "next_tag", code_cached: True, next_set_cached: True, lbEn: True, wbEn: True, load_next: True }
- { data: "next_tag", code_cached: True, next_set_cached: True, lbEn: True, wbEn: True, load_next: False }
- { data: "next_tag", code_cached: True, next_set_cached: True, lbEn: True, wbEn: False, load_next: True }
- { data: "next_tag", code_cached: True, next_set_cached: True, lbEn: True, wbEn: False, load_next: False }
- { data: "next_tag", code_cached: True, next_set_cached: True, lbEn: False, wbEn: True, load_next: True }
- { data: "next_tag", code_cached: True, next_set_cached: True, lbEn: False, wbEn: True, load_next: False }
- { data: "next_tag", code_cached: True, next_set_cached: True, lbEn: False, wbEn: False, load_next: True }
- { data: "next_tag", code_cached: True, next_set_cached: True, lbEn: False, wbEn: False, load_next: False }
- { data: "next_tag", code_cached: True, next_set_cached: False, lbEn: True, wbEn: True, load_next: True }
- { data: "next_tag", code_cached: True, next_set_cached: False, lbEn: True, wbEn: True, load_next: False }
- { data: "next_tag", code_cached: True, next_set_cached: False, lbEn: True, wbEn: False, load_next: True }
- { data: "next_tag", code_cached: True, next_set_cached: False, lbEn: True, wbEn: False, load_next: False }
- { data: "next_tag", code_cached: True, next_set_cached: False, lbEn: False, wbEn: True, load_next: True }
- { data: "next_tag", code_cached: True, next_set_cached: False, lbEn: False, wbEn: True, load_next: False }
- { data: "next_tag", code_cached: True, next_set_cached: False, lbEn: False, wbEn: False, load_next: True }
- { data: "next_tag", code_cached: True, next_set_cached: False, lbEn: False, wbEn: False, load_next: False }
- { data: "next_tag", code_cached: False, next_set_cached: True, lbEn: True, wbEn: True, load_next: True }
- { data: "next_tag", code_cached: False, next_set_cached: True, lbEn: True, wbEn: True, load_next: False }
- { data: "next_tag", code_cached: False, next_set_cached: True, lbEn: True, wbEn: False, load_next: True }
- { data: "next_tag", code_cached: False, next_set_cached: True, lbEn: True, wbEn: False, load_next: False }
- { data: "next_tag", code_cached: False, next_set_cached: True, lbEn: False, wbEn: True, load_next: True }
- { data: "next_tag", code_cached: False, next_set_cached: True, lbEn: False, wbEn: True, load_next: False }
- { data: "next_tag", code_cached: False, next_set_cached: True, lbEn: False, wbEn: False, load_next: True }
- { data: "next_tag", code_cached: False, next_set_cached: True, lbEn: False, wbEn: False, load_next: False }
- { data: "next_tag", code_cached: False, next_set_cached: False, lbEn: True, wbEn: True, load_next: True }
- { data: "next_tag", code_cached: False, next_set_cached: False, lbEn: True, wbEn: True, load_next: False }
- { data: "next_tag", code_cached: False, next_set_cached: False, lbEn: True, wbEn: False, load_next: True }
- { data: "next_tag", code_cached: False, next_set_cached: False, lbEn: True, wbEn: False, load_next: False }
- { data: "next_tag", code_cached: False, next_set_cached: False, lbEn: False, wbEn: True, load_next: True }
- { data: "next_tag", code_cached: False, next_set_cached: False, lbEn: False, wbEn: True, load_next: False }
- { data: "next_tag", code_cached: False, next_set_cached: False, lbEn: False, wbEn: False, load_next: True }
- { data: "next_tag", code_cached: False, next_set_cached: False, lbEn: False, wbEn: False, load_next: False }
# Configurations generated from:
# product:
# - data: ["same", "next_tag"]
#   code_cached: [True, False]
#   next_set_cached: [True, False]
#   lbEn: [True, False]
#   wbEn: [True, False]
#   load_next: [True, False]
...
{% device:line_buffer_enabled = lbEn %}
{% device:write_buffer_enabled = wbEn %}
{% extends "asm.s.tpl" %}

{% block code %}
    @ Prepare cycle counter timer address
    ldr.w  r0, dwt
    
    b.w    tested_code
.thumb_func
end_label:
{% endblock %}

{% block after %}

{{ section("sram") }}

.align 4
.thumb_func
.type tested_code, %function

tested_code:
    ldr.w r1, =flash_part + 1
    {{callHelper('enable_cache', r2)}}
    {{callHelper('synchronize_rng', r2, '#240')}}
    {{callHelper('disable_cache', r2)}}
    {{callHelper('enable_cache', r2)}}
    add.w r2, r1, #(ldrs - flash_part - 1)
    {% if code_cached %}
        ldr.w r3, [r2]
        ldr.w r3, [r2, #8]
    {% endif %}
    {% if next_set_cached %}
        add.w r2, #2048
        ldr.w r3, [r2]
        ldr.w r3, [r2, #8]
    {% endif %}
    blx.n r1
.align 2
    {{callHelper('disable_cache', r1)}}
    sub.w r4, r2
    {{saveValue('times', r4, r1, r2)}}
    b.w end_label

{{ section("flash") }}

@ align to set 0
.align 11
flash_part:
    adr.w r1, ldrs
    {% if data == "same" %}
        @ do nothing
    {% elif data == "next_tag" %}
        add.w r1, #2048
    {% else %}
        udf.w
    {% endif %}

    .align 3
    isb.w

    ldr.w r2, [r0, {{CYCCNT}}]

ldrs:
    ldr.w r3, [r1, #(0 + {{4 if load_next else 0}})]
    ldr.w r3, [r1, #(4 + {{4 if load_next else 0}})]
    ldr.w r3, [r1, #(8 + {{4 if load_next else 0}})]

    ldr.w r4, [r0, {{CYCCNT}}]

    bx.n lr

@ align to set 0 (next tag)
.align 11
.skip ldrs - flash_part
next_set:
.word 0
.word 0
.word 0
.word 0

{% endblock %}
