name: CACHE mode test
description: "Setting mode to cache and time"
dumped_symbols:
  debug_sum: 3 words
  address: 2 words
  COMB_res_number_LEN_4_time_3_LEN_7_time2_LEN_7_time1_LEN_7_time0_LEN_7: 250 words
configurations:
- { code: "sram", lbEn: true, pull_count: 1024, test_count: 250, test_offset: 253, test_jump: -8, extra_loads: 0, initial_offset: 0}
- { code: "sram", lbEn: true, pull_count: 1024, test_count: 250, test_offset: 253, test_jump: -8, extra_loads: 0, initial_offset: 51}
- { code: "sram", lbEn: true, pull_count: 1024, test_count: 250, test_offset: 253, test_jump: -8, extra_loads: 0, initial_offset: 101}
- { code: "sram", lbEn: true, pull_count: 1024, test_count: 250, test_offset: 253, test_jump: -8, extra_loads: 0, initial_offset: 151}
- { code: "sram", lbEn: true, pull_count: 1024, test_count: 250, test_offset: 253, test_jump: -8, extra_loads: 0, initial_offset: 201}
- { code: "sram", lbEn: true, pull_count: 1024, test_count: 250, test_offset: 253, test_jump: -8, extra_loads: 0, initial_offset: 251}
...
{% device:line_buffer_enabled = lbEn %}
{% device:write_buffer_enabled = False %}
{% extends "asm.s.tpl" %}

{% set mode_gpram = 0 %}
{% set mode_cache = 1 %}
{% set mode_off = 3 %}
{% set mode_changing = 8 %}
{% set mode_invalidating = 4 %}
{% set cache_size = 2049 %}
{% set cache_bytes = cache_size * 8 %}

{% block code %}
    @ Prepare cycle counter timer address
    ldr.w  r0, dwt
    
    b.w    tested_code
.thumb_func
end_label:
{% endblock %}

{% block after %}

{{ section("sram") }}

.align 4
LDRS: .word 0,2048,4096,6144,10240,6144,2048,4096,4096,8192,10240,12288,12288,14336,4096,0,12288,14336,0,4096,10240,0,10240,12288,10240,2048,4096,12288,6144,6144,8192,12288,2048,12288,10240,10240,14336,6144,12288,10240,4096,4096,12288,10240,8192,6144,8192,8192,2048,6144,8192,6144,6144,6144,4096,8192,12288,8192,4096,14336,10240,2048,4096,2048,14336,4096,12288,4096,2048,10240,12288,14336,8192,10240,12288,4096,14336,12288,8192,10240,10240,2048,12288,6144,0,0,6144,2048,8192,10240,8192,10240,8192,0,14336,10240,6144,12288,10240,14336,6144,12288,0,0,6144,2048,12288,10240,2048,2048,10240,14336,2048,2048,0,14336,0,10240,10240,2048,4096,10240,4096,0,4096,0,4096,14336,0,10240,0,6144,16384,2048,16384,4096,6144,8192,4096,6144,2048,12288,8192,16384,6144,0,12288,4096,10240,14336,0,16384,4096,2048,6144,2048,10240,8192,0,16384,12288,2048,6144,10240,8192,6144,0,2048,4096,16384,12288,6144,0,6144,4096,2048,8192,10240,4096,16384,10240,4096,10240,0,16384,2048,6144,2048,6144,4096,8192,10240,16384,6144,4096,0,12288,8192,6144,10240,16384,2048,4096,0,6144,8192,10240,6144,8192,2048,0,2048,0,16384,4096,6144,4096,6144,4096,6144,2048,12288,6144,0,8192,16384,10240,0,16384,2048,4096,2048,6144,8192,16384,6144,16384,6144,0,2048,8192,4096,10240,12288,6144,0,16384,2048,4096,2048,6144,0,16384,8192,2048,6144,16384,0,10240,0,10240,16384,2048,4096,6144,4096,2048,8192,16384,10240,2048,16384,6144,2048,16384,8192,6144,0,4096,2048,8192,2048,10240,4096,2048,0,16384,4096,8192,12288,16384,6144,2048,4096,0,8192,16384,4096,16384,10240,16384,10240,6144,2048,10240,2048,10240,2048,0,16384,2048,0,6144,8192,12288,16384,2048,6144,14336,16384,8192,6144,0,4096,6144,10240,12288,10240,8192,4096,6144,0,2048,8192,16384,8192,0,2048,8192,0,16384,4096,10240,12288,8192,4096,6144,0,16384,2048,6144,4096,10240,0,4096,10240,2048,16384,4096,6144,8192,0,2048,16384,4096,8192,6144,2048,6144,2048,6144,16384,4096,6144,16384,4096,0,8192,6144,10240,4096,2048,0,6144,8192,16384,2048,4096,6144,10240,2048,4096,2048,4096,6144,8192,4096,6144,10240,12288,8192,4096,6144,0,2048,16384,4096,6144,2048,8192,0,2048,4096,2048,6144,10240,12288,2048,0,16384,4096,2048,6144,8192,2048,6144,8192,2048,6144,0,4096,16384,6144,8192,10240,16384,6144,0,2048,4096,0,6144,2048,6144,4096,0,8192,16384,2048,6144,4096,0,4096,0,8192,16384,2048,6144,10240,16384,10240,16384,10240,2048,4096,12288,16384,0,2048,6144,4096,10240,0,10240,14336,2048,0,2048,0,2048,0,2048,10240,14336,0,14336,4096,16384,6144,8192,16384,2048,0,16384,0,2048,10240,16384,6144,8192,6144,0,4096,0,10240,8192,10240,6144,0,2048,0,16384,4096,0,10240,4096,0,16384,2048,4096,2048,16384,0,16384,0,16384,0,10240,4096,2048,6144,0,4096,16384,6144,0,4096,8192,2048,6144,4096,8192,10240,12288,0,16384,2048,6144,2048,6144,2048,0,16384,2048,0,16384,4096,8192,0,16384,2048,4096,16384,2048,0,4096,16384,8192,4096,8192,6144,10240,6144,16384,0,16384,14336,6144,2048,4096,6144,8192,6144,8192,6144,0,2048,4096,6144,2048,4096,6144,2048,0,4096,0,8192,12288,2048,12288,0,10240,0,8192,14336,2048,12288,0,16384,4096,0,6144,0,6144,0,6144,0,16384,4096,6144,4096,0,14336,0,16384,6144,16384,4096,12288,0,16384,2048,4096,0,16384,4096,6144,14336,6144,14336,6144,14336,0,16384,6144,16384,14336,10240,14336,0,8192,6144,16384,0,8192,4096,16384,8192,10240,8192,4096,0,4096,0,4096,0,12288,10240,16384,2048,4096,2048,6144,16384,2048,4096,0,16384,14336,2048,0,16384,0,14336,12288,2048,0,6144,0,6144,0,12288,2048,0,12288,8192,16384,2048,0,4096,16384,2048,4096,16384,0,2048,4096,16384,4096,2048,0,16384,0,4096,12288,4096,6144,16384,6144,0,14336,2048,16384,2048,16384,2048,16384,2048,4096,12288,16384,12288,2048,0,2048,10240,14336,10240,12288,16384,14336,10240,0,2048,4096,6144,4096,14336,12288,14336,12288,14336,12288,2048,6144,4096,14336,16384,6144,4096,14336,16384,6144,4096,0,14336,2048,4096,2048,8192,16384,0,6144,10240,2048,0,4096,16384,2048,8192,4096,6144,2048,8192,4096,8192,2048,0,4096,0,8192,6144,8192,12288,4096,12288,0,8192,4096,12288,0,4096,16384,4096,6144,8192,6144,8192,6144,8192,0,16384,12288,6144,8192,2048,12288,14336,8192,2048,12288,0,16384,2048,12288,2048,10240,8192,6144,2048,16384,2048,16384,2048,8192,14336,2048,8192,14336,12288,2048,8192,14336,12288,2048,14336,12288,8192,2048,6144,14336,8192,6144,0,14336,2048,14336,2048,8192,6144,8192,6144,8192,10240,2048,6144,0,10240,16384,10240,2048,4096,0,2048,4096,16384,4096,10240,2048,4096,8192,4096,10240,2048,8192,0,16384,0,6144,8192,16384,10240,6144,2048,16384,4096,8192,16384,8192,16384,8192,16384,8192,2048,4096,16384,4096,8192,10240,8192,2048,16384,2048,12288,4096,16384,2048,12288,16384,10240,16384,2048,4096,2048,4096,2048,4096,0,12288,10240,12288,10240,12288,10240,12288,8192,0,2048,0,12288,14336,16384,8192,2048,8192,12288,16384,2048,6144,12288,4096,2048,4096,6144,16384,0,16384,0,16384,12288,2048,4096,0,14336,2048,4096,0,14336,2048,4096,8192,12288,6144,2048,6144,8192,4096,12288,6144,8192,6144,8192,6144,10240,12288,6144,10240,12288,2048,6144,10240,12288,2048,6144,12288,2048,10240,6144,0,16384,4096,0,2048,16384,10240,16384,10240,14336,0,14336,0,14336,4096,10240,0,14336,4096,10240,4096,10240,0,14336,10240,0,4096,0,14336,10240,0,6144,0,14336,10240,6144,10240,6144,0,8192,14336,2048,0,8192,10240,8192,6144,2048,6144,2048,0,10240,12288,6144,12288,8192,0,2048,6144,12288,4096,12288,0,6144,12288,14336,0,6144,14336,2048,0,4096,14336,4096,2048,10240,4096,2048,14336,10240,4096,14336,10240,4096,14336,2048,10240,6144,10240,4096,2048,6144,2048,8192,4096,10240,2048,14336,8192,4096,8192,4096,16384,14336,8192,14336,8192,14336,8192,4096,16384,8192,2048,4096,14336,16384,12288,2048,4096,14336,12288,4096,14336,12288,16384,12288,0,2048,10240,16384,10240,16384,10240,12288,0,4096,2048,6144,4096,2048,6144,4096,2048,6144,8192,6144,8192,6144,4096,16384,0,6144,16384,0,4096,0,4096,6144,16384,0,4096,12288,4096,12288,4096,12288,4096,12288,6144,2048,6144,2048,0,16384,8192,4096,8192,4096,2048

.align 4
rng_sync:
    ldr.w r2, =CACHE_ENTRY
    mov.w r3, #1024
    add.w r3, #153
    ldr.w r4, =LDRS
sync_loop:
    ldr.n r5, [r4]
    adds.n r4, #4
    adds.n r6, r2, r5
    ldr.n  r1, [r6]
    subs.n r3, #1
    bne.n sync_loop
    bx.n lr

.align	4
@ [TI-TRM] 3.2.8 Cortex-M3 Memory Map
@ [TI-TRM] 7.9.2.1 STAT Register
@ [TI-TRM] 7.9.2.2 CTL Register
VIMS_STAT:	    	.word	0x40034000
VIMS_CTL:	    	.word	0x40034004
TEST_OFFSET:        .word   {{test_offset}}

{{ section(code) }}

.align 4
.thumb_func
.type tested_code, %function

tested_code:
    @ Prepare register addresses
    ldr.w  r11, VIMS_STAT
    ldr.w  r12, VIMS_CTL

    @ Offset RNG

    @ Change mode
    ldr.w  r2, [r12]
    and.w  r2, r2, #0xfffffffc
    orr.w  r2, r2, #{{mode_cache}}
    str.w  r2, [r12]
    
    bl.w stabilize_mode

    ldr.w r2, =CACHE_ENTRY
    mov.w r3, #{{initial_offset}}
    b.w offset_rng_cond
offset_rng:
    ldr.w r7, [r2]
    add.w r2, #24
    sub.w r3, #1
offset_rng_cond:
    cmp.w r3, #0
    bne.w offset_rng

    bl.w reset_mode

    @ Synchronize RNG

    @ Change mode
    ldr.w  r2, [r12]
    and.w  r2, r2, #0xfffffffc
    orr.w  r2, r2, #{{mode_cache}}
    str.w  r2, [r12]
    
    bl.w stabilize_mode
    
    mov.w  r9, #0
{% if pull_count > 0 %}
    ldr.w  r4, =CACHE_ENTRY
    mov.w  r5, r4
    mov.w  r7, #2048
    sub.w  r7, #1
    mov.w  r2, #{{pull_count}}
load_cache:
    sub.w  r6, r4, r5
    tst.w  r6, r7
    beq.w   skip_ldr
    ldr.w  r3, [r4]
skip_ldr:
    add.w  r9, r3
    add.w  r4, #8
    subs.w r2, #1
    bne.w  load_cache
{% endif %}
	
	
	@ Do extra loads to offset RNG sequence.
	mov.w  r3, #0                   @ counter
	mov.w  r5, #{{extra_loads}}     @ limit
	mov.w  r6, #0                   @ address offset
	mov.w  r7, #{{cache_bytes}}     @ cache size in bytes
extra_load_loop:
	cmp.w  r3, r5
	bhs.w  extra_load_loop_end
	add.w  r3, #1
	
	ldr.w  r4, =CACHE_ENTRY
	add.w  r4, r6
	ldr.w  r2, [r4]
	add.w  r8, r2

	add.w  r6, #0x800
	cmp.w  r6, r7
	blo.w  extra_load_skip_reset_r6
	mov.w  r6, #0
extra_load_skip_reset_r6:
	
	b.w    extra_load_loop
	
extra_load_loop_end:

    @ Synchronize RNG
    bl.w rng_sync

    mov.w  r8, #0

    @ Prepare starting address.
    ldr.w  r10, =CACHE_ENTRY
    
    ldr.w  r2, TEST_OFFSET
    lsl.w  r2, #3
    add.w  r10, r2
    add.w  r10, #0x2000

    mov.w  r4, r10
    mov.w  r3, #{{test_count}}

    @ Pull all test addresses.
test_pull_loop:
    ldr.w  r10, [r4]
    add.w  r8, r10
    add.w  r4, #{{test_jump}}
    subs.w r3, 1
    bne.w  test_pull_loop
    
    bl.w save_test_and_pull_sum

    @ Prepare cache test access.
    ldr.w  r4, =CACHE_ENTRY
    
    ldr.w  r2, TEST_OFFSET
    lsl.w  r2, #3
    add.w  r4, r2
    
    mov.w  r8, #0
    mov.w  r9, #0
    
    
test_loop:
    .align 4
    mov.w  r10, #0x0
    
    mov.w  r1, #0x9
    
{% for i in range(4) %}
{% set offset = i * 2048 %}
    
    add.w  r3, r4, #{{offset}}
    
    @ Flush queue.
    isb.w

    ldr.n  r7, [r0, {{CYCCNT}}]
    
    ldr.n  r6, [r3]
    
    ldr.n  r2, [r0, {{CYCCNT}}]
    add.n  r8, r6
    sub.w  r7, r2, r7
    
    mov.w   r2, #100
    cmp.w   r7, #7
    it      hs
    movhs.w r2, #{{i}}
    cmp.w   r1, r2
    it      hs
    movhs.w r1, r2
    
    lsl.w  r10, #7
    orr.w  r10, r7
    
{% endfor %}

	lsl.w  r10, #4
	orr.w  r10, r1
    
    bl.w save_single_round
    
    add.w  r4, #{{test_jump}}
    add.w  r9, #1
    mov.w  r2, #{{test_count}}
    cmp.w  r9, r2
    
    bne.w test_loop
    
    ldr.n  r5, [r0, {{CYCCNT}}]
    
    bl.w save_final
    
    bl.w reset_mode

    b.w end_label


@ Turns off the cache and waits to stabilize.
@ Assumes:
@ Destroys:
@ r2
.align 4
reset_mode:
    @ Prepare register addresses
    ldr.w  r11, VIMS_STAT
    ldr.w  r12, VIMS_CTL
    ldr.w r2, [r12]
    and.w r2, r2, #0xfffffffc
    orr.w r2, r2, #{{mode_off}}
    str.w r2, [r12]

@ Waits for mode to stabilize.
@ Assumes:
@ r11 = VIMS_STAT
@ Destroys:
@ r2
.align 4
stabilize_mode:
    @ check if changing
    ldr.w r2, [r11]
    ands.w r2, r2, #{{mode_changing + mode_invalidating}}
    bne.w stabilize_mode
    
    bx.n lr

.align 4
save_single_round:
    {{saveValue('COMB_res_number_LEN_4_time_3_LEN_7_time2_LEN_7_time1_LEN_7_time0_LEN_7', r10, r2, r3)}}

    bx.n lr

.align 4
save_test_and_pull_sum:
    {{saveValue('debug_sum', r8, r2, r3)}}
    {{saveValue('debug_sum', r9, r2, r3)}}
    
    bx.n lr

.align 4
save_final:
    ldr.w r4, =CACHE_ENTRY
    {{saveValue('address', r4, r2, r3)}}
    ldr.w r4, =test_loop
    {{saveValue('address', r4, r2, r3)}}
    {{saveValue('debug_sum', r8, r2, r3)}}

    bx.n lr



{{ section("flash") }}

.align 15
CACHE_ENTRY:    .4byte {% for i in range(cache_size) %} {{ i }}, {{ i + 1000000007 }}, {% endfor %}

{% endblock %}
